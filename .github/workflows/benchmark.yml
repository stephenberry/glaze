name: benchmark

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  skip_ws_benchmark:
    runs-on: ubuntu-24.04

    env:
      CC: gcc-14
      CXX: g++-14

    steps:
    - uses: actions/checkout@v4

    - name: Verify AVX2 support
      run: grep -q avx2 /proc/cpuinfo && echo "AVX2 is available"

    - name: Configure CMake
      run: |
        cmake -S "$GITHUB_WORKSPACE/benchmarks" -B "$GITHUB_WORKSPACE/build" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=${{env.CC}} \
          -DCMAKE_CXX_COMPILER=${{env.CXX}}

    - name: Build
      run: cmake --build "$GITHUB_WORKSPACE/build" -j $(nproc) --target skip_ws_benchmark

    - name: Run benchmark
      run: |
        output=$("$GITHUB_WORKSPACE/build/skip_ws_benchmark")
        echo "$output"
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo '## skip_ws benchmark results' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "$output" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
        fi

  string_write_benchmark:
    runs-on: ubuntu-24.04

    env:
      CC: gcc-14
      CXX: g++-14

    steps:
    - uses: actions/checkout@v4

    - name: Verify AVX2 support
      run: grep -q avx2 /proc/cpuinfo && echo "AVX2 is available"

    - name: Configure CMake
      run: |
        cmake -S "$GITHUB_WORKSPACE/benchmarks" -B "$GITHUB_WORKSPACE/build" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=${{env.CC}} \
          -DCMAKE_CXX_COMPILER=${{env.CXX}}

    - name: Build
      run: cmake --build "$GITHUB_WORKSPACE/build" -j $(nproc) --target string_write_benchmark

    - name: Run benchmark
      run: |
        output=$(LD_LIBRARY_PATH="$GITHUB_WORKSPACE/build" "$GITHUB_WORKSPACE/build/string_write_benchmark")
        echo "$output"
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo '## string_write benchmark results' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "$output" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
        fi
